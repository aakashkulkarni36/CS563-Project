Issue #965: Fix that DigdagClient raises JsonParseException
URL: https://github.com/treasure-data/digdag/pull/965

Commit ID: 6c140a026422beae8505c5be88614a4b36a8ad08

Commit Message: Fix that DigdagClient raises JsonParseException

with Accept-Encoding: gzip server.

This issue occurs with digdag >= 0.9.26, and the cause is by resteasy-cient >= 3.0.20.Final.

The resteasy-client now works naturally, and the workaround is not needed anymore.

Files Changed (2):
File: digdag-client/src/main/java/io/digdag/client/DigdagClient.java ======================
    - Additions: 7
    - Deletions: 12
=======================================================

    +++Added (new line 48): import org.jboss.resteasy.plugins.interceptors.encoding.AcceptEncodingGZIPFilter;
    +++Added (new line 49): import org.jboss.resteasy.plugins.interceptors.encoding.GZIPDecodingInterceptor;
    +++Added (new line 50): import org.jboss.resteasy.plugins.interceptors.encoding.GZIPEncodingInterceptor;
    ---Removed (old line 219):         // Set "Accept-Encoding: gzip". This is necessary to override "Accept-Encoding: gzip, deflate"
    ---Removed (old line 220):         // header set by org.apache.httpcomponents:httpclient automatically. If server returns response
    ---Removed (old line 221):         // with deflate compression, this client throws an exception (JsonParseException). It's because
    ---Removed (old line 222):         // response body parsing is parsed by RESTEasy's GZIPDecodingInterceptor and it apparently runs
    ---Removed (old line 223):         // before httpclient's decompression. It means that this client actually doesn't support
    ---Removed (old line 224):         // deflate compression.
    ---Removed (old line 225):         ImmutableMap.Builder<String, String> baseHeadersBuilder = ImmutableMap.builder();
    ---Removed (old line 226):         baseHeadersBuilder.put("Accept-Encoding", "gzip");
    ---Removed (old line 227):         baseHeadersBuilder.putAll(builder.baseHeaders);
    ---Removed (old line 228): 
    ---Removed (old line 229):         final Map<String, String> baseHeaders = baseHeadersBuilder.build();
    ---Removed (old line 230): 
    +++Added (new line 222):         final Map<String, String> baseHeaders = builder.baseHeaders;
    +++Added (new line 236):                 .register(AcceptEncodingGZIPFilter.class)
    +++Added (new line 237):                 .register(GZIPDecodingInterceptor.class)
    +++Added (new line 238):                 .register(GZIPEncodingInterceptor.class)

File: digdag-client/src/test/java/io/digdag/client/DigdagClientTest.java ======================
    - Additions: 1
    - Deletions: 1
=======================================================

    ---Removed (old line 265):         assertThat(request.getHeader(ACCEPT_ENCODING), is("gzip"));
    +++Added (new line 265):         assertThat(request.getHeader(ACCEPT_ENCODING), is("gzip, deflate"));

